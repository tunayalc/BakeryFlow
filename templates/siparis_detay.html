{% extends "layout.html" %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Sipariş Detayı #{{ siparis.id }}</h2>
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('index') }}">Anasayfa</a>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-12 mb-4">
                    <div class="position-relative m-4" style="height: 100px;">
                        <div class="progress" style="height: 1px; top: 16px; position: relative;">
                            <div class="progress-bar" role="progressbar"
                                style="width: {% if siparis.durum == 'OLUSTURULDU' or siparis.durum == 'ONAY_BEKLIYOR' %}0%{% elif siparis.durum == 'ONAYLANDI' %}25%{% elif siparis.durum == 'HAZIRLANIYOR' %}50%{% elif siparis.durum == 'KURYE_ATANDI' or siparis.durum == 'YOLDA' %}75%{% elif siparis.durum == 'TESLIM_EDILDI' %}100%{% else %}0%{% endif %};"
                                aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="position-absolute top-0 start-0 translate-middle btn btn-sm btn-{% if siparis.durum in ['OLUSTURULDU','ONAY_BEKLIYOR','ONAYLANDI','HAZIRLANIYOR','KURYE_ATANDI','YOLDA','TESLIM_EDILDI'] %}primary{% else %}secondary{% endif %} rounded-pill"
                            style="width: 2rem; height:2rem;">1</div>
                        <div class="position-absolute top-0 start-25 translate-middle btn btn-sm btn-{% if siparis.durum in ['ONAYLANDI','HAZIRLANIYOR','KURYE_ATANDI','YOLDA','TESLIM_EDILDI'] %}primary{% else %}secondary{% endif %} rounded-pill"
                            style="width: 2rem; height:2rem; left: 25%;">2</div>
                        <div class="position-absolute top-0 start-50 translate-middle btn btn-sm btn-{% if siparis.durum in ['HAZIRLANIYOR','KURYE_ATANDI','YOLDA','TESLIM_EDILDI'] %}primary{% else %}secondary{% endif %} rounded-pill"
                            style="width: 2rem; height:2rem; left: 50%;">3</div>
                        <div class="position-absolute top-0 start-75 translate-middle btn btn-sm btn-{% if siparis.durum in ['KURYE_ATANDI','YOLDA','TESLIM_EDILDI'] %}primary{% else %}secondary{% endif %} rounded-pill"
                            style="width: 2rem; height:2rem; left: 75%;">4</div>
                        <div class="position-absolute top-0 start-100 translate-middle btn btn-sm btn-{% if siparis.durum == 'TESLIM_EDILDI' %}success{% else %}secondary{% endif %} rounded-pill"
                            style="width: 2rem; height:2rem;">5</div>

                        <div class="position-absolute top-0 start-0 translate-middle-x mt-4 small fw-bold">Alındı</div>
                        <div class="position-absolute top-0 start-25 translate-middle-x mt-4 small fw-bold"
                            style="left: 25%;">Onaylandı</div>
                        <div class="position-absolute top-0 start-50 translate-middle-x mt-4 small fw-bold"
                            style="left: 50%;">Hazırlanıyor</div>
                        <div class="position-absolute top-0 start-75 translate-middle-x mt-4 small fw-bold"
                            style="left: 75%;">Yolda</div>
                        <div class="position-absolute top-0 start-100 translate-middle-x mt-4 small fw-bold">Teslim
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="text-muted small">Durum</div>
                    <div class="fw-bold">
                        {{ siparis.durum }}
                        {% if siparis.durum == 'ONAY_BEKLIYOR' and session['rol'] == 'MUSTERI' and siparis.musteri_id ==
                        session['user_id'] %}
                        <form action="{{ url_for('siparis_iptal', id=siparis.id) }}" method="POST" class="d-inline ms-2"
                            onsubmit="return confirm('Siparişi iptal etmek istediğinize emin misiniz?');">
                            <button class="btn btn-danger btn-sm p-0 px-2">
                                <i class="fas fa-times me-1"></i> İptal
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-muted small">Tarih</div>
                    <div class="fw-bold">{{ siparis.tarih }}</div>
                </div>
                <div class="col-md-4">
                    <div class="text-muted small">Toplam</div>
                    <div class="fw-bold">
                        {{ siparis.toplam_tutar }} ₺
                        {% if siparis.indirim_tutari and siparis.indirim_tutari > 0 %}
                        <span class="badge bg-success ms-2">{{ siparis.kupon_kodu }} (-%{{
                            siparis.indirim_tutari|round(2) }} ₺)</span>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="text-muted small">Müşteri</div>
                    <div class="fw-bold">{{ siparis.musteri_ad }} {{ siparis.musteri_soyad }} ({{ siparis.musteri_kadi
                        }})
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="text-muted small">Kurye</div>
                    <div class="fw-bold">
                        {% if siparis.kurye_id %}
                        {{ siparis.kurye_ad }} {{ siparis.kurye_soyad }} ({{ siparis.kurye_kadi }})
                        {% else %}
                        <span class="text-muted">Atanmadı</span>
                        {% endif %}
                    </div>
                </div>
                <div class="col-12">
                    <div class="text-muted small">Teslimat Adresi</div>
                    <div class="fw-bold">{{ siparis.adres_basligi }}: <span class="fw-normal">{{ siparis.acik_adres
                            }}</span>
                    </div>
                </div>
            </div>

            <div class="mt-3">
                {% if session.get('rol') == 'ADMIN' %}
                {% if siparis.durum == 'ONAY_BEKLIYOR' %}
                <form method="POST" action="{{ url_for('admin_siparis_islem', id=siparis.id, action='onayla') }}"
                    class="d-inline">
                    <button type="submit" class="btn btn-success btn-sm">Onayla</button>
                </form>
                <form method="POST" action="{{ url_for('admin_siparis_islem', id=siparis.id, action='iptal') }}"
                    class="d-inline">
                    <button type="submit" class="btn btn-outline-danger btn-sm">İptal</button>
                </form>
                {% elif siparis.durum == 'HAZIRLANIYOR' %}
                <form method="POST" action="{{ url_for('admin_siparis_islem', id=siparis.id, action='iptal') }}"
                    class="d-inline">
                    <button type="submit" class="btn btn-outline-danger btn-sm">İptal</button>
                </form>
                {% elif siparis.durum == 'TESLIM_EDILDI' %}
                <form method="POST" action="{{ url_for('admin_siparis_islem', id=siparis.id, action='kapat') }}"
                    class="d-inline">
                    <button type="submit" class="btn btn-outline-success btn-sm">Kapat</button>
                </form>
                {% endif %}
                {% endif %}

                {% if session.get('rol') == 'KURYE' %}

                {% if siparis.durum == 'HAZIRLANIYOR' or siparis.durum == 'KURYE_ATANDI' %}
                <!-- Siparişi Teslim Alıp Yola Çıkar -->
                <form method="POST" action="{{ url_for('kurye_islem', id=siparis.id, action='teslim_al') }}"
                    class="d-inline" onsubmit="return confirm('Siparişi teslim alıp yola çıkarmak istiyor musunuz?');">
                    <button type="submit" class="btn btn-warning btn-sm">
                        <i class="fas fa-motorcycle me-1"></i> Yola Çıkar
                    </button>
                </form>

                {% elif siparis.durum == 'YOLDA' or siparis.durum == 'KURYEDE' %}
                <!-- Müşteriye Teslim Et -->
                <form method="POST" action="{{ url_for('kurye_islem', id=siparis.id, action='teslim_et') }}"
                    class="d-inline"
                    onsubmit="return confirm('Sipariş tesil edildi olarak işaretlenecek. Emin misiniz?');">
                    <button type="submit" class="btn btn-success btn-sm">
                        <i class="fas fa-check-circle me-1"></i> Teslim Edildi
                    </button>
                </form>
                {% endif %}

                {% endif %}
                <!-- Kurye sipariş detaydan da mesaj atamaz, sadece yanıt verebilir. -->

                {% if session.get('rol') == 'MUSTERI' and siparis.kurye_id and siparis.durum == 'YOLDA' %}
                <!-- Customer Message to Courier (Sadece YOLDA iken) -->
                <button type="button" class="btn btn-sm btn-outline-primary ms-2" data-bs-toggle="modal"
                    data-bs-target="#msgKuryeModal">
                    <i class="fas fa-motorcycle me-1"></i> Kuryeye Yaz
                </button>
                {% endif %}
            </div>

            <!-- Modals -->
            {% if session.get('rol') == 'KURYE' %}
            <div class="modal fade" id="msgMusteriModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form action="{{ url_for('mesaj_gonder') }}" method="POST">
                            <div class="modal-header">
                                <h5 class="modal-title">Müşteriye Mesaj: {{ siparis.musteri_ad }}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <input type="hidden" name="alici_rol" value="MUSTERI">
                                <input type="hidden" name="alici_id" value="{{ siparis.musteri_id }}">
                                <div class="mb-3">
                                    <label>Konu</label>
                                    <input type="text" name="konu" class="form-control"
                                        value="Sipariş #{{ siparis.id }}" required>
                                </div>
                                <div class="mb-3">
                                    <label>Mesaj</label>
                                    <textarea name="mesaj" class="form-control" rows="3" required></textarea>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-primary">Gönder</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if session.get('rol') == 'MUSTERI' and siparis.kurye_id %}
            <div class="modal fade" id="msgKuryeModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form action="{{ url_for('mesaj_gonder') }}" method="POST">
                            <div class="modal-header">
                                <h5 class="modal-title">Kuryeye Mesaj: {{ siparis.kurye_ad }}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <input type="hidden" name="alici_rol" value="KURYE">
                                <input type="hidden" name="alici_id" value="{{ siparis.kurye_id }}">
                                <div class="mb-3">
                                    <label>Konu</label>
                                    <input type="text" name="konu" class="form-control"
                                        value="Sipariş #{{ siparis.id }}" required>
                                </div>
                                <div class="mb-3">
                                    <label>Mesaj</label>
                                    <textarea name="mesaj" class="form-control" rows="3" required></textarea>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-primary">Gönder</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
            <h5 class="mb-0">Sipariş Kalemleri</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Ürün</th>
                            <th class="text-end">Adet</th>
                            <th class="text-end">Birim Fiyat</th>
                            <th class="text-end">Ara Toplam</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for d in detaylar %}
                        <tr>
                            <td>{{ d.urun_ad }}</td>
                            <td class="text-end">{{ d.adet }}</td>
                            <td class="text-end">{{ d.birim_fiyat }} ₺</td>
                            <td class="text-end">{{ (d.adet * d.birim_fiyat) }} ₺</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="text-center text-muted py-4">Detay yok.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Durum ve Stok tabloları kullanıcı isteği üzerine kaldırıldı -->
</div>
{% endblock %}